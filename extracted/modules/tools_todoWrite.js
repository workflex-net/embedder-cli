// Category: tools/todoWrite
// Modules: 1
// Total size: 13,636 chars


// === Module: J6B (offset: 0xcadc39, 13,636 chars) ===
var J6B=z(()=>{qI();Z4();aKA();wC();Y6B=dE({metadata:{name:"todoWrite",displayName:"Todo Write",description:"Create and manage a structured task list for your coding session. Helps track progress and organize complex tasks.",category:"development"},inputSchema:L6B,validateParams:({todos:A})=>{for(let E of A){if(!E.content||E.content.trim().length===0)return"All todo items must have non-empty content";if(!E.id||E.id.trim().length===0)return"All todo items must have an ID"}let B=A.map((E)=>E.id);if(B.length!==new Set(B).size)return"Todo items must have unique IDs";if(A.filter((E)=>E.status===Xg.IN_PROGRESS).length>1)return"Only one todo can be 'in_progress' at a time";return null},getDescription:({todos:A})=>U6B(wz(A)),getLocations:()=>[],execute:async({todos:A})=>{try{let B=ZF(),Q=A.map((C)=>({...C,id:C.id||G6B()}));AN(B,Q);let E=wz(Q),g=Q.map((C)=>{let I=C.status===Xg.COMPLETED?"[x]":"[ ]",w=C.status===Xg.CANCELLED?`~~${C.content}~~`:C.status===Xg.IN_PROGRESS?`**${C.content}**`:C.content;return`${I} ${w}`}).join(`
`);return{success:!0,summary:`Updated ${Q.length} todos (${E.pendingCount} pending, ${E.inProgressCount} in progress, ${E.completedCount} done)`,llmContent:`Todo list updated:
${g}`,metadata:{todoMetadata:E,todos:Q,sessionId:B}}}catch(B){return{success:!1,llmContent:`Error updating todos: ${uQ(B)}`,summary:"Failed to update todos"}}}})});function RHE(A){if(A==="act")return uJ;return Object.fromEntries(Object.entries(uJ).filter(([Q])=>LZB(Q,A)))}async function S6B(A){let B=RHE(A),Q=await Promise.all(Object.entries(B).map(async([E,g])=>{if(g.metadata.isAvailable)return await g.metadata.isAvailable()?[E,g]:null;return[E,g]}));return Object.fromEntries(Q.filter(Boolean))}var uJ;var gz=z(async()=>{ZKA();eVB();V7();BZB();CZB();wZB();Mu();YZB();fZB();hZB();PZB();tZB();Z7();mZB();eZB();B6B();K6B();J6B();await pQ([aVB(),UZB(),TZB(),VZB(),WZB(),F6B()]);uJ={readFile:oZB,writeFile:XZB,editFile:KZB,listDirectory:xZB,grep:rZB,shell:H6B,glob:$ZB,todoRead:R6B,todoWrite:Y6B,askQuestion:pVB,documentSearch:AZB,codeSearch:rVB,webSearch:IZB,webFetch:gZB,serialMonitor:NZB,serialReadHistory:yZB,serialSendCommand:qZB,compressConversation:_xB,initProject:$xB,submitPlan:_ZB,lsp:A6B,delegateSubagent:uVB}});function x6B(A){let B=A.filter((g)=>!(("displayOnly"in g)&&g.displayOnly)),Q=[],E=0;while(E<B.length){let g=B[E];if(!g)break;if(g.role==="user"){if(g.content?.trim())Q.push({role:"user",content:g.content});E++}else if(g.role==="assistant"){let C=[],I=E+1;while(I<B.length&&B[I]?.role==="tool-group"){let w=B[I];if(w)C.push(w);I++}if(C.length>0){let w=[];if("content"in g&&g.content?.trim())w.push({type:"text",text:g.content});for(let D of C)for(let H of D.toolGroup.tools)w.push({type:"tool-call",toolCallId:H.toolCallId,toolName:H.toolName,input:H.args});Q.push({role:"assistant",content:w});for(let D of C)for(let H of D.toolGroup.tools){let L=H.compactedAt?"[Old tool result content cleared]":H.result?.llmContent||"";Q.push({role:"tool",content:[{type:"tool-result",toolCallId:H.toolCallId,toolName:H.toolName,output:{type:"text",value:L}}]})}E=I}else{if("content"in g&&g.content?.trim())Q.push({role:"assistant",content:g.content});E++}}else if(g.role==="tool-group"){let C=[];while(E<B.length&&B[E]?.role==="tool-group"){let w=B[E];if(w)C.push(w);E++}let I=[];for(let w of C)for(let D of w.toolGroup.tools)I.push({type:"tool-call",toolCallId:D.toolCallId,toolName:D.toolName,input:D.args});Q.push({role:"assistant",content:I});for(let w of C)for(let D of w.toolGroup.tools){let H=D.compactedAt?"[Old tool result content cleared]":D.result?.llmContent||"";Q.push({role:"tool",content:[{type:"tool-result",toolCallId:D.toolCallId,toolName:D.toolName,output:{type:"text",value:H}}]})}}}return Q}function f6B(A){let B=A.result,Q=typeof B==="object"?B.success:!0,E=uJ[A.toolName],g=E?.getDisplayName?.(A.args)??E?.metadata?.displayName??A.toolName,C={id:$D(),toolCallId:A.toolCallId,toolName:A.toolName,displayName:g,status:Q?"success":"error",args:A.args,result:typeof B==="object"?B:{success:!0,llmContent:String(B)},startTime:Date.now(),endTime:Date.now()};return{id:$D(),status:"completed",tools:[C],startTime:Date.now(),endTime:Date.now()}}function c6B(A){let B=uJ[A.toolName],Q=B?.getDisplayName?.(A.args)??B?.metadata?.displayName??A.toolName,E={id:$D(),toolCallId:A.toolCallId,toolName:A.toolName,displayName:Q,status:"executing",args:A.args,startTime:Date.now()};return{id:$D(),status:"executing",tools:[E],startTime:Date.now()}}function k6B(A,B){let Q=B.result,E=typeof Q==="object"?Q.success:!0,g=Date.now(),C=A.toolGroup.tools.map((I)=>{if(I.toolCallId===B.toolCallId)return{...I,status:E?"success":"error",args:B.args,result:typeof Q==="object"?Q:{success:!0,llmContent:String(Q)},endTime:g};return I});return{...A,toolGroup:{...A.toolGroup,status:"completed",tools:C,endTime:g}}}function o6B(A,B,Q){let E=Date.now(),g=A.toolGroup.tools.map((C)=>{if(C.toolCallId===B)return{...C,status:"error",result:{success:!1,llmContent:`Error: ${Q}`,returnDisplay:`Error: ${Q}`,summary:"Tool execution failed"},endTime:E};return C});return{...A,toolGroup:{...A.toolGroup,status:"completed",tools:g,endTime:E}}}function h6B(A){let B=Date.now(),Q=A.toolGroup.tools.map((E)=>{if(E.status==="executing"||E.status==="pending")return{...E,status:"error",result:{success:!1,llmContent:"Tool execution aborted",returnDisplay:"Tool execution aborted",summary:"Aborted"},endTime:B};return E});return{...A,toolGroup:{...A.toolGroup,status:"completed",tools:Q,endTime:B}}}function X6B(A,B,Q){let E=A.toolGroup.tools.map((g)=>{if(g.toolCallId===B)return{...g,status:Q};return g});return{...A,toolGroup:{...A.toolGroup,tools:E}}}var P6B=z(async()=>{wC();await gz()});function JHE(A){return Math.max(0,Math.round((A||"").length/KHE))}function SHE(A){if(A.config?.auto===!1)return!1;let B=A.model.limits?.context??$KA;if(B===0)return!1;let E=s9(A.tokens,A.model.provider)+A.tokens.output,g=Math.min(A.model.limits?.output??mKA,jN),C=B-g;return E>C}function N6B(A){let B=A.model.limits?.context??$KA;if(B===0)return{overflow:!1,exceedsThreshold:!1,percentUsed:0,effectiveTokens:0,usableContext:0};let E=s9(A.tokens,A.model.provider)+A.tokens.output,g=Math.min(A.model.limits?.output??mKA,jN),C=B-g;if(C<=0)return{overflow:!1,exceedsThreshold:!1,percentUsed:0,effectiveTokens:E,usableContext:0};let I=Math.round(E/C*100),w=C*TLA;return{overflow:E>C,exceedsThreshold:E>w,percentUsed:I,effectiveTokens:E,usableContext:C}}function T6B(A,B,Q,E){if(!Q)return!1;if(E){let I=s9(E,Q.provider)+E.output,w=fx(B)+10,D=I+w,H=td(Q),L=H>0?Math.round(D/H*100):0;return _d(L)}let g=yLA(A,B,Q);return _d(g.percentUsed)}function xHE(A,B){let Q=A.filter((D)=>D.role==="assistant"&&!!D.tokens&&!(("displayOnly"in D)&&D.displayOnly)).at(-1);if(Q?.tokens)return SHE({tokens:Q.tokens,model:B});let E=A.filter((D)=>!(("displayOnly"in D)&&D.displayOnly)),g=cx(E),C=B.limits?.context??$KA,I=Math.min(B.limits?.output??mKA,jN),w=C-I;return g>w}function fHE(A){return lKA.has(A)}function y6B(A){return A.summary===!0}function V6B(A){let B=-1;for(let Q=A.length-1;Q>=0;Q--){let E=A[Q];if(!E)continue;if(E.role==="assistant"&&y6B(E)){B=Q;break}}if(B===-1)return A;return A.slice(B)}function cHE(A,B){if(B?.prune===!1)return fA.debug("Pruning disabled by config"),{prunedCount:0,prunedTokens:0,messages:A};fA.info("Pruning started",{messageCount:A.length,pruneProtect:O6B,pruneMinimum:Ru});let Q=0,E=0,g=[],C=0;for(let w=A.length-1;w>=0;w--){let D=A[w];if(!D)continue;if(D.role==="user")C++;if(C<2)continue;if(D.role==="assistant"&&y6B(D))break;if(D.role==="tool-group")for(let H=D.toolGroup.tools.length-1;H>=0;H--){let L=D.toolGroup.tools[H];if(!L)continue;if(L.status!=="success"&&L.status!=="error")continue;if(YHE.includes(L.toolName))continue;if(L.compactedAt)break;let R=L.result?.llmContent||"",U=JHE(R);if(Q+=U,Q>O6B)E+=U,g.push({messageIndex:w,toolIndex:H,toolName:L.toolName,tokens:U})}}if(fA.info("Pruning analysis complete",{totalToolTokens:Q,tokensOverThreshold:E,toolsToPrune:g.length,willPrune:E>=Ru}),E<Ru)return fA.debug("Pruning skipped - below minimum threshold",{pruned:E,minimum:Ru}),{prunedCount:0,prunedTokens:0,messages:A};let I=A.map((w,D)=>{if(w.role!=="tool-group")return w;let H=g.filter((R)=>R.messageIndex===D).map((R)=>R.toolIndex);if(H.length===0)return w;let L=w.toolGroup.tools.map((R,U)=>{if(H.includes(U))return{...R,compactedAt:Date.now()};return R});return{...w,toolGroup:{...w.toolGroup,tools:L}}});return fA.info("Pruning complete",{prunedCount:g.length,prunedTokens:E,prunedTools:g.map((w)=>`${w.toolName}(${w.tokens})`)}),{prunedCount:g.length,prunedTokens:E,messages:I}}function Z6B(A){let B=[];for(let Q of A)if(Q.role==="user")B.push(`USER: ${Q.content}`);else if(Q.role==="assistant")B.push(`ASSISTANT: ${Q.content}`);else if(Q.role==="tool-group"){for(let E of Q.toolGroup.tools)if(B.push(`TOOL: ${E.toolName} - ${E.displayName}`),E.compactedAt)B.push("TOOL_RESULT: [Old tool result content cleared]");else if(E.result?.llmContent)B.push(`TOOL_RESULT: ${E.result.llmContent}`)}return B.join(`

`)}async function oHE(A,B){let E=`Provide a detailed prompt for continuing our conversation above. Focus on information that would be helpful for continuing the conversation, including what we did, what we're doing, which files we're working on, and what we're going to do next considering new session will not have access to our conversation.

Here is the conversation to summarize:

${Z6B(A)}`;try{let g=await G4({model:B,system:kHE,messages:[{role:"user",content:E}]}),C="";for await(let I of g.textStream)C+=I;return C}catch(g){throw Error(`Failed to generate compaction summary: ${uQ(g)}`)}}function hHE(A,B){let Q={id:`summary-${Date.now()}`,role:"assistant",content:B,timestamp:Date.now(),summary:!0};return[...A.map((g)=>{if("displayOnly"in g&&g.displayOnly)return g;return{...g,displayOnly:!0}}),Q]}async function vN(A,B,Q,E){if(fHE(B))return{success:!1,originalTokenCount:0,newTokenCount:0,compressedMessages:A,error:"Compaction already in progress for this session"};lKA.set(B,{isCompressing:!0,sessionId:B,startTime:Date.now()});try{let{messages:g}=cHE(A,E),C=g.filter((U)=>!(("displayOnly"in U)&&U.displayOnly)),I=cx(C),w=await oHE(C,Q),D=hHE(g,w),H=D.filter((U)=>!(("displayOnly"in U)&&U.displayOnly)),L=cx(H),R=Math.round((1-L/I)*100);return fA.info("Compaction complete",{sessionId:B,originalTokens:I,newTokens:L,reduction:`${R}%`}),FI({category:"session",message:"Conversation compacted",level:"info",data:{sessionId:B,originalMessageCount:C.length,newMessageCount:H.length,originalTokens:I,newTokens:L,reductionPercent:R}}),{success:!0,originalTokenCount:I,newTokenCount:L,compressedMessages:D}}catch(g){cO(g,{operation:"conversation_compaction",component:"compression",metadata:{sessionId:B,messageCount:A.length}});let C=A.filter((w)=>!(("displayOnly"in w)&&w.displayOnly)),I=cx(C);return{success:!1,originalTokenCount:I,newTokenCount:I,compressedMessages:A,error:uQ(g)}}finally{lKA.delete(B)}}async function q6B(A,B,Q,E,g=!1){if(!g&&!xHE(A,Q)){let C=A.filter((w)=>!(("displayOnly"in w)&&w.displayOnly)),I=cx(C);return{success:!1,originalTokenCount:I,newTokenCount:I,compressedMessages:A,error:"Compression not needed"}}return vN(A,B,E)}async function W6B(A,B){let Q=Z6B(A),E=Q.length>8000?`${Q.slice(0,8000)}

[conversation truncated...]`:Q,g=`You are a conversation summarizer. Generate a VERY SHORT summary (max 60 characters) that describes what this conversation is about. Focus on the main task or topic being discussed.

Examples of good summaries:
- "Implementing dark mode toggle"
- "Fixing authentication bug"
- "Refactoring database queries"
- "Setting up CI/CD pipeline"
- "Debugging API rate limits"

Rules:
- Maximum 60 characters
- Start with a verb (Implementing, Fixing, Adding, etc.) or topic noun
- No quotes, no periods at the end
- Be specific about what's being worked on
- Output ONLY the summary, nothing else`;try{let C=await G4({model:B,system:`You are a conversation summarizer. Generate a VERY SHORT summary (max 60 characters) that describes what this conversation is about. Focus on the main task or topic being discussed.

Examples of good summaries:
- "Implementing dark mode toggle"
- "Fixing authentication bug"
- "Refactoring database queries"
- "Setting up CI/CD pipeline"
- "Debugging API rate limits"

Rules:
- Maximum 60 characters
- Start with a verb (Implementing, Fixing, Adding, etc.) or topic noun
- No quotes, no periods at the end
- Be specific about what's being worked on
- Output ONLY the summary, nothing else`,messages:[{role:"user",content:`Summarize this conversation in under 60 characters:

${E}`}],maxOutputTokens:50}),I="";for await(let D of C.textStream)I+=D;let w=I.trim().replace(/^["']|["']$/g,"").replace(/\.$/,"");return w.length>60?`${w.slice(0,57)}...`:w}catch(C){fA.error("Failed to generate short summary",{error:C});let I=A.find((w)=>w.role==="user");if(I&&I.role==="user"){let w=I.content;return w.length>60?`${w.slice(0,57)}...`:w}return"New conversation"}}var jN=32000,$KA=200000,mKA=64000,KHE=4,Ru=20000,O6B=40000,YHE,lKA,kHE=`You are a helpful AI assistant tasked with summarizing conversations.

When asked to summarize, provide a detailed but concise summary of the conversation. 
Focus on information that would be helpful for continuing the conversation, including:
- What was done
- What is currently being worked on
- Which files are being modified
- What needs to be done next
- Key user requests, constraints, or preferences that should persist
- Important technical decisions and why they were made

Your summary should be comprehensive enough to provide context but concise enough to be quickly understood.`;
