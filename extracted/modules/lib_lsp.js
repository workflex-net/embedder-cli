// Category: lib/lsp
// Modules: 4
// Total size: 14,932 chars


// === Module: O4 (offset: 0xba01d8, 5,013 chars) ===
var O4=z(()=>{_JB();uJB();pJB();$LA();eJB();C7=Symbol("fallbackAttempt"),IUA=import.meta.url?gSB.dirname(JuQ(import.meta.url)):"",ASB=gSB.join(IUA,"xdg-open"),{platform:jO,arch:BSB}=CUA;X4={browser:"browser",browserPrivate:"browserPrivate"};h4(X4,"chrome",()=>l9({darwin:"google chrome",win32:"chrome",linux:["google-chrome","google-chrome-stable","chromium","chromium-browser"]},{wsl:{ia32:"/mnt/c/Program Files (x86)/Google/Chrome/Application/chrome.exe",x64:["/mnt/c/Program Files/Google/Chrome/Application/chrome.exe","/mnt/c/Program Files (x86)/Google/Chrome/Application/chrome.exe"]}}));h4(X4,"brave",()=>l9({darwin:"brave browser",win32:"brave",linux:["brave-browser","brave"]},{wsl:{ia32:"/mnt/c/Program Files (x86)/BraveSoftware/Brave-Browser/Application/brave.exe",x64:["/mnt/c/Program Files/BraveSoftware/Brave-Browser/Application/brave.exe","/mnt/c/Program Files (x86)/BraveSoftware/Brave-Browser/Application/brave.exe"]}}));h4(X4,"firefox",()=>l9({darwin:"firefox",win32:String.raw`C:\Program Files\Mozilla Firefox\firefox.exe`,linux:"firefox"},{wsl:"/mnt/c/Program Files/Mozilla Firefox/firefox.exe"}));h4(X4,"edge",()=>l9({darwin:"microsoft edge",win32:"msedge",linux:["microsoft-edge","microsoft-edge-dev"]},{wsl:"/mnt/c/Program Files (x86)/Microsoft/Edge/Application/msedge.exe"}));h4(X4,"safari",()=>l9({darwin:"Safari"}));P4=cuQ});import{chmod as ISB,mkdir as I7,rm as wSB}from"fs/promises";import{homedir as ouQ,tmpdir as DSB}from"os";import{join as TF}from"path";var{$:huQ,gunzipSync:XuQ}=globalThis.Bun;async function sO(A){try{return await Bun.file(A).stat(),!0}catch{return!1}}function w7(){return TF(ouQ(),".embedder","bin")}async function VuQ(A){return new Promise((B)=>setTimeout(B,A))}async function MSB(A){let B;for(let Q=0;Q<CSB;Q++){let E=new AbortController,g=setTimeout(()=>E.abort(),OuQ);try{let C=await fetch(A,{signal:E.signal});if(clearTimeout(g),C.ok)return C;B=Error(`HTTP ${C.status}: ${C.statusText}`)}catch(C){clearTimeout(g),B=C instanceof Error?C:Error(String(C))}if(Q<CSB-1){let C=NuQ*2**Q;fA.debug(`Download failed, retrying in ${C}ms...`),await VuQ(C)}}throw B??Error("Download failed after retries")}async function HSB(A,B){{let Q=await huQ`unzip -o ${A} -d ${B}`.quiet().nothrow();if(Q.exitCode!==0)throw Error(`Failed to extract zip archive: ${Q.stderr.toString()}`)}}async function ZuQ(A,B){let Q=await Bun.file(A).arrayBuffer(),E=XuQ(new Uint8Array(Q));await Bun.write(B,E)}async function quQ(A){let E=TF(A,"clangd"),g="x64-linux",C=TuQ["x64-linux"];if(!C)return fA.debug("clangd not available for platform: x64-linux"),null;let I=`https://github.com/clangd/clangd/releases/download/${iO}/${C}`;await I7(A,{recursive:!0});let w=TF(DSB(),`clangd-install-${Date.now()}`);await I7(w,{recursive:!0});let D=TF(w,C);try{fA.info("Downloading clangd...");let L=await(await MSB(I)).arrayBuffer();await Bun.write(D,L),await HSB(D,w);let R=TF(w,`clangd_${iO}`),U=TF(R,"bin","clangd");if(!await sO(U))return fA.debug(`clangd binary not found at ${U}`),null;return await Bun.write(E,await Bun.file(U).arrayBuffer()),await ISB(E,493),fA.info(`clangd installed to ${E}`),E}catch(H){let L=H instanceof Error?H.message:String(H);return fA.debug(`Failed to install clangd: ${L}`),null}finally{await wSB(w,{recursive:!0,force:!0}).catch(()=>{})}}async function WuQ(A){let E=TF(A,"rust-analyzer"),g="x64-linux",C=yuQ["x64-linux"];if(!C)return fA.debug("rust-analyzer not available for platform: x64-linux"),null;let I=`https://github.com/rust-lang/rust-analyzer/releases/download/${PuQ}/${C}`;await I7(A,{recursive:!0});let w=TF(DSB(),`rust-analyzer-install-${Date.now()}`);await I7(w,{recursive:!0});let D=TF(w,C);try{fA.info("Downloading rust-analyzer...");let L=await(await MSB(I)).arrayBuffer();if(await Bun.write(D,L),C.endsWith(".zip")){await HSB(D,w);let R=TF(w,"rust-analyzer");if(!await sO(R))return fA.debug(`rust-analyzer binary not found at ${R}`),null;await Bun.write(E,await Bun.file(R).arrayBuffer())}else if(C.endsWith(".gz"))await ZuQ(D,E);return await ISB(E,493),fA.info(`rust-analyzer installed to ${E}`),E}catch(H){let L=H instanceof Error?H.message:String(H);return fA.debug(`Failed to install rust-analyzer: ${L}`),null}finally{await wSB(w,{recursive:!0,force:!0}).catch(()=>{})}}async function FSB(){let Q=w7(),E=TF(Q,"clangd");if(await sO(E))return!0;if(Bun.which("clangd"))return!0;return!1}async function LSB(){let Q=w7(),E=TF(Q,"rust-analyzer");if(await sO(E))return!0;if(Bun.which("rust-analyzer"))return!0;return!1}async function zuQ(){let Q=w7(),E=TF(Q,"clangd");if(await sO(E))return E;let g=Bun.which("clangd");if(g)return g;return quQ(Q)}async function juQ(){let Q=w7(),E=TF(Q,"rust-analyzer");if(await sO(E))return E;let g=Bun.which("rust-analyzer");if(g)return g;return WuQ(Q)}async function MUA(){if(!wUA)wUA=zuQ();return wUA}async function HUA(){if(!DUA)DUA=juQ();return DUA}async function USB(){let[A,B]=await Promise.all([MUA(),HUA()]);return{clangd:A,rustAnalyzer:B}}var iO="19.1.2",PuQ="2024-12-23",OuQ=60000,CSB=3,NuQ=1000,TuQ,yuQ,wUA,DUA;

// === Module: D7 (offset: 0xba156d, 401 chars) ===
var D7=z(()=>{ZE();TuQ={"arm64-darwin":`clangd-mac-${iO}.zip`,"x64-darwin":`clangd-mac-${iO}.zip`,"x64-linux":`clangd-linux-${iO}.zip`,"x64-win32":`clangd-windows-${iO}.zip`},yuQ={"arm64-darwin":"rust-analyzer-aarch64-apple-darwin.gz","x64-darwin":"rust-analyzer-x86_64-apple-darwin.gz","x64-linux":"rust-analyzer-x86_64-unknown-linux-gnu.gz","x64-win32":"rust-analyzer-x86_64-pc-windows-msvc.zip"}});

// === Module: IxB (offset: 0xbaf62c, 4,002 chars) ===
var IxB=z(()=>{CxB={".c":"c",".cpp":"cpp",".cxx":"cpp",".cc":"cpp",".c++":"cpp",".h":"c",".hpp":"cpp",".hh":"cpp",".hxx":"cpp",".h++":"cpp",".rs":"rust"}});import AW from"path";import{fileURLToPath as hlQ,pathToFileURL as c7}from"url";async function wxB(A){fA.debug(`Starting LSP client for ${A.serverID}`);let B=$O.createMessageConnection(new $O.StreamMessageReader(A.server.process.stdout),new $O.StreamMessageWriter(A.server.process.stdin)),Q=new Map;B.onNotification("textDocument/publishDiagnostics",(C)=>{let I=hlQ(C.uri);fA.trace(`Received diagnostics for ${I}`),Q.set(I,C.diagnostics),HG.publish("lsp.diagnostics",{serverID:A.serverID,path:I})}),B.onRequest("workspace/configuration",async()=>{return[A.server.initialization??{}]}),B.onRequest("window/workDoneProgress/create",()=>{return null}),B.onRequest("client/registerCapability",async()=>{}),B.onRequest("client/unregisterCapability",async()=>{}),B.onRequest("workspace/workspaceFolders",async()=>[{name:"workspace",uri:c7(A.root).href}]),B.listen(),fA.debug(`Sending initialize request to ${A.serverID}`);try{await Promise.race([B.sendRequest("initialize",{rootUri:c7(A.root).href,processId:A.server.process.pid,workspaceFolders:[{name:"workspace",uri:c7(A.root).href}],initializationOptions:{...A.server.initialization},capabilities:{window:{workDoneProgress:!0},workspace:{configuration:!0,didChangeWatchedFiles:{dynamicRegistration:!0},symbol:{dynamicRegistration:!1}},textDocument:{synchronization:{didOpen:!0,didChange:!0},publishDiagnostics:{versionSupport:!0},definition:{dynamicRegistration:!1,linkSupport:!0},references:{dynamicRegistration:!1},hover:{dynamicRegistration:!1,contentFormat:["plaintext","markdown"]},documentSymbol:{dynamicRegistration:!1,hierarchicalDocumentSymbolSupport:!0},implementation:{dynamicRegistration:!1,linkSupport:!0},callHierarchy:{dynamicRegistration:!1}}}}),new Promise((C,I)=>setTimeout(()=>I(Error("LSP initialization timeout")),XlQ))])}catch(C){return fA.error(`Failed to initialize LSP client ${A.serverID}`,C),B.end(),B.dispose(),A.server.process.kill(),null}if(await B.sendNotification("initialized",{}),A.server.initialization)await B.sendNotification("workspace/didChangeConfiguration",{settings:A.server.initialization});fA.debug(`LSP client initialized for ${A.serverID}`);let E={};return{root:A.root,serverID:A.serverID,connection:B,diagnostics:Q,notify:{async open(C){let I=AW.isAbsolute(C.path)?C.path:AW.resolve(process.cwd(),C.path);try{let w=await Bun.file(I).text(),D=AW.extname(I),H=CxB[D]??"plaintext",L=c7(I).href,R=E[I];if(R!==void 0){fA.trace(`workspace/didChangeWatchedFiles (Changed) for ${I}`),await B.sendNotification("workspace/didChangeWatchedFiles",{changes:[{uri:L,type:2}]});let U=R+1;E[I]=U,fA.trace(`textDocument/didChange for ${I} (v${U})`),await B.sendNotification("textDocument/didChange",{textDocument:{uri:L,version:U},contentChanges:[{text:w}]});return}fA.trace(`workspace/didChangeWatchedFiles (Created) for ${I}`),await B.sendNotification("workspace/didChangeWatchedFiles",{changes:[{uri:L,type:1}]}),fA.trace(`textDocument/didOpen for ${I}`),Q.delete(I),await B.sendNotification("textDocument/didOpen",{textDocument:{uri:L,languageId:H,version:0,text:w}}),E[I]=0}catch(w){fA.error(`Failed to open file in LSP: ${I}`,w)}}},async waitForDiagnostics(C){let I=AW.isAbsolute(C.path)?C.path:AW.resolve(process.cwd(),C.path);fA.trace(`Waiting for diagnostics for ${I}`);let w,D,H,L=new Promise((U)=>{w=HG.subscribe("lsp.diagnostics",(G)=>{if(G.path===I&&G.serverID===A.serverID){if(D)clearTimeout(D);D=setTimeout(()=>{fA.trace(`Got diagnostics for ${I}`),U()},OlQ)}})}),R=new Promise((U)=>{H=setTimeout(()=>{fA.trace(`Diagnostics timeout for ${I}`),U()},PlQ)});return Promise.race([L,R]).catch(()=>{}).finally(()=>{if(D)clearTimeout(D);if(H)clearTimeout(H);w?.()})},async shutdown(){fA.debug(`Shutting down LSP client ${A.serverID}`),B.end(),B.dispose(),A.server.process.kill(),fA.debug(`LSP client ${A.serverID} shut down`)}}}var $O,XlQ=5000,PlQ=3000,OlQ=150;

// === Module: FxB (offset: 0xbb07c9, 5,516 chars) ===
var FxB=z(()=>{ZE();D7();TlQ={id:"clangd",root:NlQ(["compile_commands.json","compile_flags.txt",".clangd","CMakeLists.txt","Makefile"]),extensions:[".c",".cpp",".cc",".cxx",".c++",".h",".hpp",".hh",".hxx",".h++"],async spawn(A){let B=await MUA();if(!B){fA.debug("clangd not available");return}return{process:MxB(B,["--background-index","--clang-tidy"],{cwd:A,stdio:["pipe","pipe","pipe"]})}}},ylQ={id:"rust",root:async(A)=>{let B=process.cwd(),Q=rR.dirname(A),E;while(Q.startsWith(B)){for(let I of["Cargo.toml","Cargo.lock"]){let w=rR.join(Q,I);try{await dUA(w),E=Q;break}catch{}}if(E)break;let C=rR.dirname(Q);if(C===Q)break;Q=C}if(!E)return;let g=E;while(g.startsWith(B)){let C=rR.join(g,"Cargo.toml");try{if((await Bun.file(C).text()).includes("[workspace]"))return g}catch{}let I=rR.dirname(g);if(I===g)break;if(g=I,!g.startsWith(B))break}return E},extensions:[".rs"],async spawn(A){let B=await HUA();if(!B){fA.debug("rust-analyzer not available");return}return{process:MxB(B,[],{cwd:A,stdio:["pipe","pipe","pipe"]})}}},HxB={clangd:TlQ,rust:ylQ}});import LxB from"path";import{pathToFileURL as y4}from"url";async function UxB(){if(T4)return T4;return T4={servers:HxB,clients:[],broken:new Set},fA.debug("LSP system initialized",{servers:Object.keys(T4.servers).join(", ")}),T4}async function BW(){if(!T4)return await UxB();return T4}async function GxB(A){let B=await BW(),Q=LxB.extname(A)||A,E=[];for(let g of Object.values(B.servers)){if(g.extensions.length&&!g.extensions.includes(Q))continue;let C=await g.root(A);if(!C)continue;if(B.broken.has(C+g.id))continue;let I=B.clients.find((w)=>w.root===C&&w.serverID===g.id);if(I){E.push(I);continue}try{let w=await g.spawn(C);if(!w){B.broken.add(C+g.id);continue}fA.debug(`Spawned LSP server ${g.id} at ${C}`);let D=await wxB({serverID:g.id,server:w,root:C});if(!D){B.broken.add(C+g.id),w.process.kill();continue}B.clients.push(D),E.push(D)}catch(w){B.broken.add(C+g.id),fA.error(`Failed to spawn LSP server ${g.id}`,w)}}return E}async function VlQ(A,B){let Q=await GxB(A);await Promise.all(Q.map(async(E)=>{if(await E.notify.open({path:A}),B)await E.waitForDiagnostics({path:A})})).catch((E)=>{fA.error("Failed to touch file in LSP",{error:E,file:A})})}async function ZlQ(){let A=await BW(),B={};for(let Q of A.clients)for(let[E,g]of Q.diagnostics.entries()){let C=B[E]||[];C.push(...g),B[E]=C}return B}async function qlQ(){let A=await BW();await Promise.all(A.clients.map((B)=>B.shutdown())),A.clients=[],fA.debug("All LSP clients shut down")}function zlQ(A){let B=WlQ[A.severity??1]??"ERROR",Q=A.range.start.line+1,E=A.range.start.character+1;return`${B} [${Q}:${E}] ${A.message}`}async function jlQ(A){let B=await BW(),Q=LxB.extname(A)||A;for(let E of Object.values(B.servers)){if(E.extensions.length&&!E.extensions.includes(Q))continue;let g=await E.root(A);if(!g)continue;if(B.broken.has(g+E.id))continue;return!0}return!1}async function Ox(A,B){let E=(await GxB(A)).map((g)=>B(g));return Promise.all(E)}async function vlQ(A){let Q=(await BW()).clients.map((E)=>A(E));return Promise.all(Q)}async function ilQ(A){return Ox(A.file,(B)=>B.connection.sendRequest("textDocument/definition",{textDocument:{uri:y4(A.file).href},position:{line:A.line,character:A.character}}).catch(()=>null)).then((B)=>B.flat().filter(Boolean))}async function slQ(A){return Ox(A.file,(B)=>B.connection.sendRequest("textDocument/references",{textDocument:{uri:y4(A.file).href},position:{line:A.line,character:A.character},context:{includeDeclaration:!0}}).catch(()=>[])).then((B)=>B.flat().filter(Boolean))}async function blQ(A){return Ox(A.file,(B)=>B.connection.sendRequest("textDocument/hover",{textDocument:{uri:y4(A.file).href},position:{line:A.line,character:A.character}}).catch(()=>null)).then((B)=>B.filter(Boolean))}async function dlQ(A){let B=new URL(A).pathname;return Ox(B,(Q)=>Q.connection.sendRequest("textDocument/documentSymbol",{textDocument:{uri:A}}).catch(()=>[])).then((Q)=>Q.flat()).then((Q)=>Q.filter(Boolean))}async function tlQ(A){return vlQ((B)=>B.connection.sendRequest("workspace/symbol",{query:A}).then((Q)=>Q.filter((E)=>_lQ.includes(E.kind))).then((Q)=>Q.slice(0,10)).catch(()=>[])).then((B)=>B.flat())}async function ulQ(A){return Ox(A.file,(B)=>B.connection.sendRequest("textDocument/implementation",{textDocument:{uri:y4(A.file).href},position:{line:A.line,character:A.character}}).catch(()=>null)).then((B)=>B.flat().filter(Boolean))}async function alQ(A){return Ox(A.file,(B)=>B.connection.sendRequest("textDocument/prepareCallHierarchy",{textDocument:{uri:y4(A.file).href},position:{line:A.line,character:A.character}}).catch(()=>[])).then((B)=>B.flat().filter(Boolean))}async function llQ(A){return Ox(A.file,async(B)=>{let Q=await B.connection.sendRequest("textDocument/prepareCallHierarchy",{textDocument:{uri:y4(A.file).href},position:{line:A.line,character:A.character}}).catch(()=>[]);if(!Q?.length)return[];return B.connection.sendRequest("callHierarchy/incomingCalls",{item:Q[0]}).catch(()=>[])}).then((B)=>B.flat().filter(Boolean))}async function $lQ(A){return Ox(A.file,async(B)=>{let Q=await B.connection.sendRequest("textDocument/prepareCallHierarchy",{textDocument:{uri:y4(A.file).href},position:{line:A.line,character:A.character}}).catch(()=>[]);if(!Q?.length)return[];return B.connection.sendRequest("callHierarchy/outgoingCalls",{item:Q[0]}).catch(()=>[])}).then((B)=>B.flat().filter(Boolean))}async function mlQ(){if(k7!==null)return k7;let[A,B]=await Promise.all([FSB(),LSB()]);return k7=A||B,k7}var T4=null,k7=null,WlQ,_lQ,sC;
